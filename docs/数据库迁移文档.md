# 数据库迁移文档

## 概述

本文档描述了 Claude FastAPI 项目的数据库迁移系统，包括配置、使用方法和常见操作。

## 技术栈

- **Alembic**: SQLAlchemy 数据库迁移工具
- **PostgreSQL**: 主数据库
- **SQLAlchemy**: ORM 框架

## 项目结构

```
backend/
├── alembic/                    # Alembic 迁移目录
│   ├── versions/              # 迁移版本文件
│   │   └── 001_initial_migration.py
│   ├── env.py                 # Alembic 环境配置
│   ├── script.py.mako         # 迁移脚本模板
│   └── README                 # Alembic 说明
├── alembic.ini               # Alembic 配置文件
├── db/
│   ├── base.py              # 数据库基础配置
│   └── seed.py              # 种子数据脚本
└── models/
    └── user.py              # 用户模型
```

## 环境配置

### 1. 环境变量设置

复制环境变量模板：
```bash
cp .env.example .env
```

编辑 `.env` 文件，配置数据库连接：
```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/claude_fastapi
```

### 2. Docker 环境

如果使用 Docker，确保 `docker-compose.yml` 中数据库服务正常：
```yaml
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: claude_fastapi
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
```

## 数据库迁移操作

### 1. 启动数据库服务

**Docker 方式**：
```bash
docker-compose up -d db redis
```

**本地 PostgreSQL**：
确保本地 PostgreSQL 服务运行，并创建数据库：
```sql
CREATE DATABASE claude_fastapi;
```

### 2. 运行迁移

进入 backend 目录：
```bash
cd backend
```

**执行迁移**：
```bash
alembic upgrade head
```

**查看迁移状态**：
```bash
alembic current
alembic history --verbose
```

### 3. 初始化种子数据

```bash
python -m db.seed
```

或者：
```bash
python db/seed.py
```

## 常用命令

### Alembic 命令

| 命令 | 说明 |
|------|------|
| `alembic upgrade head` | 升级到最新迁移 |
| `alembic downgrade -1` | 回退一个迁移 |
| `alembic current` | 查看当前迁移版本 |
| `alembic history` | 查看迁移历史 |
| `alembic show <revision>` | 查看具体迁移内容 |

### 创建新迁移

```bash
# 自动生成迁移（需要数据库连接）
alembic revision --autogenerate -m "描述信息"

# 手动创建空迁移
alembic revision -m "描述信息"
```

### 种子数据命令

```bash
# 初始化种子数据
python db/seed.py

# 重置数据库并重新种子化
python db/seed.py reset
```

## 数据库模式

### Users 表结构

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,                              -- 用户ID
    username VARCHAR(50) UNIQUE NOT NULL,               -- 用户名
    email VARCHAR(100) UNIQUE NOT NULL,                 -- 邮箱
    hashed_password VARCHAR(255) NOT NULL,              -- 加密密码
    full_name VARCHAR(100),                             -- 全名
    avatar VARCHAR(255),                                -- 头像URL
    phone VARCHAR(20),                                  -- 手机号
    is_active BOOLEAN DEFAULT TRUE,                     -- 是否激活
    is_superuser BOOLEAN DEFAULT FALSE,                 -- 是否超级用户
    is_verified BOOLEAN DEFAULT FALSE,                  -- 是否验证邮箱
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- 创建时间
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- 更新时间
    last_login_at TIMESTAMP WITH TIME ZONE,             -- 最后登录时间
    bio TEXT                                            -- 个人简介
);

-- 索引
CREATE INDEX ix_users_id ON users(id);
CREATE INDEX ix_users_username ON users(username);
CREATE INDEX ix_users_email ON users(email);
```

## 默认账户

种子数据会创建以下默认账户：

### 超级管理员
- **用户名**: admin
- **密码**: admin123456
- **邮箱**: admin@example.com
- **权限**: 超级用户

### 测试用户
- **用户名**: testuser1, testuser2, developer
- **密码**: testpass123 / devpass123
- **权限**: 普通用户

## 故障排除

### 1. 数据库连接失败

**错误信息**: `connection to server at "localhost", port 5432 failed`

**解决方案**:
- 确保 PostgreSQL 服务运行
- 检查数据库连接参数
- 确认数据库存在

```bash
# 检查 PostgreSQL 状态
brew services list | grep postgresql

# 启动 PostgreSQL
brew services start postgresql
```

### 2. 迁移版本冲突

**错误信息**: `Multiple head revisions are present`

**解决方案**:
```bash
# 合并迁移分支
alembic merge -m "merge heads" head1 head2

# 或重置到特定版本
alembic downgrade <revision>
```

### 3. 导入模块错误

**错误信息**: `ImportError: attempted relative import beyond top-level package`

**解决方案**:
- 确保在正确目录执行命令
- 检查 PYTHONPATH 设置
- 使用绝对导入路径

### 4. 权限错误

**错误信息**: `FATAL: password authentication failed`

**解决方案**:
```bash
# 重置 PostgreSQL 用户密码
ALTER USER postgres PASSWORD 'postgres';

# 或创建新用户
CREATE USER claude_user WITH PASSWORD 'claude_pass';
GRANT ALL PRIVILEGES ON DATABASE claude_fastapi TO claude_user;
```

## 生产环境迁移

### 1. 备份数据库

```bash
pg_dump -h localhost -U postgres -d claude_fastapi > backup.sql
```

### 2. 执行迁移

```bash
# 1. 停止应用服务
# 2. 备份数据库
# 3. 执行迁移
alembic upgrade head
# 4. 启动应用服务
```

### 3. 回滚计划

```bash
# 回退到上一个版本
alembic downgrade -1

# 回退到特定版本
alembic downgrade <revision_id>
```

## 最佳实践

### 1. 迁移文件命名

- 使用描述性名称：`add_user_table`, `add_email_index`
- 包含日期信息：`2023_09_04_add_user_table`
- 版本号递增：`001_initial`, `002_add_roles`

### 2. 迁移内容

- 每次迁移只做一件事
- 提供完整的 `upgrade()` 和 `downgrade()` 函数
- 添加适当的注释和说明

### 3. 测试流程

```bash
# 1. 测试升级
alembic upgrade head

# 2. 验证数据完整性
python -c "from db.base import engine; print(engine.execute('SELECT COUNT(*) FROM users'))"

# 3. 测试回退
alembic downgrade -1

# 4. 重新升级
alembic upgrade head
```

### 4. 团队协作

- 合并代码前先拉取最新迁移
- 解决迁移冲突后再推送
- 在不同环境保持迁移同步

## 监控和日志

### 1. 迁移日志

Alembic 会记录迁移执行日志到 `alembic_version` 表：

```sql
SELECT * FROM alembic_version;
```

### 2. 应用日志

应用启动时会输出数据库连接状态：
```
🚀 Claude FastAPI started successfully!
📊 API Documentation: http://localhost:8000/docs
```

## API 健康检查

访问健康检查端点验证数据库连接：
```bash
curl http://localhost:8000/health
```

响应示例：
```json
{
  "status": "healthy",
  "redis": "healthy",
  "timestamp": "2023-09-04T22:30:00.000000Z",
  "version": "1.0.0"
}
```

## 相关文档

- [用户认证API文档](./用户认证API文档.md)
- [功能文档](./功能文档.md)
- [SQLAlchemy 官方文档](https://docs.sqlalchemy.org/)
- [Alembic 官方文档](https://alembic.sqlalchemy.org/)

---

*本文档随着项目发展持续更新*