# æ•°æ®åº“è¿ç§»æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† Claude FastAPI é¡¹ç›®çš„æ•°æ®åº“è¿ç§»ç³»ç»Ÿï¼ŒåŒ…æ‹¬é…ç½®ã€ä½¿ç”¨æ–¹æ³•å’Œå¸¸è§æ“ä½œã€‚

## æŠ€æœ¯æ ˆ

- **Alembic**: SQLAlchemy æ•°æ®åº“è¿ç§»å·¥å…·
- **PostgreSQL**: ä¸»æ•°æ®åº“
- **SQLAlchemy**: ORM æ¡†æ¶

## é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ alembic/                    # Alembic è¿ç§»ç›®å½•
â”‚   â”œâ”€â”€ versions/              # è¿ç§»ç‰ˆæœ¬æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ 001_initial_migration.py
â”‚   â”œâ”€â”€ env.py                 # Alembic ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ script.py.mako         # è¿ç§»è„šæœ¬æ¨¡æ¿
â”‚   â””â”€â”€ README                 # Alembic è¯´æ˜
â”œâ”€â”€ alembic.ini               # Alembic é…ç½®æ–‡ä»¶
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ base.py              # æ•°æ®åº“åŸºç¡€é…ç½®
â”‚   â””â”€â”€ seed.py              # ç§å­æ•°æ®è„šæœ¬
â””â”€â”€ models/
    â””â”€â”€ user.py              # ç”¨æˆ·æ¨¡å‹
```

## ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå˜é‡è®¾ç½®

å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼š
```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ï¼š
```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/claude_fastapi
```

### 2. Docker ç¯å¢ƒ

å¦‚æœä½¿ç”¨ Dockerï¼Œç¡®ä¿ `docker-compose.yml` ä¸­æ•°æ®åº“æœåŠ¡æ­£å¸¸ï¼š
```yaml
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: claude_fastapi
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
```

## æ•°æ®åº“è¿ç§»æ“ä½œ

### 1. å¯åŠ¨æ•°æ®åº“æœåŠ¡

**Docker æ–¹å¼**ï¼š
```bash
docker-compose up -d db redis
```

**æœ¬åœ° PostgreSQL**ï¼š
ç¡®ä¿æœ¬åœ° PostgreSQL æœåŠ¡è¿è¡Œï¼Œå¹¶åˆ›å»ºæ•°æ®åº“ï¼š
```sql
CREATE DATABASE claude_fastapi;
```

### 2. è¿è¡Œè¿ç§»

è¿›å…¥ backend ç›®å½•ï¼š
```bash
cd backend
```

**æ‰§è¡Œè¿ç§»**ï¼š
```bash
alembic upgrade head
```

**æŸ¥çœ‹è¿ç§»çŠ¶æ€**ï¼š
```bash
alembic current
alembic history --verbose
```

### 3. åˆå§‹åŒ–ç§å­æ•°æ®

```bash
python -m db.seed
```

æˆ–è€…ï¼š
```bash
python db/seed.py
```

## å¸¸ç”¨å‘½ä»¤

### Alembic å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `alembic upgrade head` | å‡çº§åˆ°æœ€æ–°è¿ç§» |
| `alembic downgrade -1` | å›é€€ä¸€ä¸ªè¿ç§» |
| `alembic current` | æŸ¥çœ‹å½“å‰è¿ç§»ç‰ˆæœ¬ |
| `alembic history` | æŸ¥çœ‹è¿ç§»å†å² |
| `alembic show <revision>` | æŸ¥çœ‹å…·ä½“è¿ç§»å†…å®¹ |

### åˆ›å»ºæ–°è¿ç§»

```bash
# è‡ªåŠ¨ç”Ÿæˆè¿ç§»ï¼ˆéœ€è¦æ•°æ®åº“è¿æ¥ï¼‰
alembic revision --autogenerate -m "æè¿°ä¿¡æ¯"

# æ‰‹åŠ¨åˆ›å»ºç©ºè¿ç§»
alembic revision -m "æè¿°ä¿¡æ¯"
```

### ç§å­æ•°æ®å‘½ä»¤

```bash
# åˆå§‹åŒ–ç§å­æ•°æ®
python db/seed.py

# é‡ç½®æ•°æ®åº“å¹¶é‡æ–°ç§å­åŒ–
python db/seed.py reset
```

## æ•°æ®åº“æ¨¡å¼

### Users è¡¨ç»“æ„

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,                              -- ç”¨æˆ·ID
    username VARCHAR(50) UNIQUE NOT NULL,               -- ç”¨æˆ·å
    email VARCHAR(100) UNIQUE NOT NULL,                 -- é‚®ç®±
    hashed_password VARCHAR(255) NOT NULL,              -- åŠ å¯†å¯†ç 
    full_name VARCHAR(100),                             -- å…¨å
    avatar VARCHAR(255),                                -- å¤´åƒURL
    phone VARCHAR(20),                                  -- æ‰‹æœºå·
    is_active BOOLEAN DEFAULT TRUE,                     -- æ˜¯å¦æ¿€æ´»
    is_superuser BOOLEAN DEFAULT FALSE,                 -- æ˜¯å¦è¶…çº§ç”¨æˆ·
    is_verified BOOLEAN DEFAULT FALSE,                  -- æ˜¯å¦éªŒè¯é‚®ç®±
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- åˆ›å»ºæ—¶é—´
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- æ›´æ–°æ—¶é—´
    last_login_at TIMESTAMP WITH TIME ZONE,             -- æœ€åç™»å½•æ—¶é—´
    bio TEXT                                            -- ä¸ªäººç®€ä»‹
);

-- ç´¢å¼•
CREATE INDEX ix_users_id ON users(id);
CREATE INDEX ix_users_username ON users(username);
CREATE INDEX ix_users_email ON users(email);
```

## é»˜è®¤è´¦æˆ·

ç§å­æ•°æ®ä¼šåˆ›å»ºä»¥ä¸‹é»˜è®¤è´¦æˆ·ï¼š

### è¶…çº§ç®¡ç†å‘˜
- **ç”¨æˆ·å**: admin
- **å¯†ç **: admin123456
- **é‚®ç®±**: admin@example.com
- **æƒé™**: è¶…çº§ç”¨æˆ·

### æµ‹è¯•ç”¨æˆ·
- **ç”¨æˆ·å**: testuser1, testuser2, developer
- **å¯†ç **: testpass123 / devpass123
- **æƒé™**: æ™®é€šç”¨æˆ·

## æ•…éšœæ’é™¤

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `connection to server at "localhost", port 5432 failed`

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ PostgreSQL æœåŠ¡è¿è¡Œ
- æ£€æŸ¥æ•°æ®åº“è¿æ¥å‚æ•°
- ç¡®è®¤æ•°æ®åº“å­˜åœ¨

```bash
# æ£€æŸ¥ PostgreSQL çŠ¶æ€
brew services list | grep postgresql

# å¯åŠ¨ PostgreSQL
brew services start postgresql
```

### 2. è¿ç§»ç‰ˆæœ¬å†²çª

**é”™è¯¯ä¿¡æ¯**: `Multiple head revisions are present`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åˆå¹¶è¿ç§»åˆ†æ”¯
alembic merge -m "merge heads" head1 head2

# æˆ–é‡ç½®åˆ°ç‰¹å®šç‰ˆæœ¬
alembic downgrade <revision>
```

### 3. å¯¼å…¥æ¨¡å—é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `ImportError: attempted relative import beyond top-level package`

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿åœ¨æ­£ç¡®ç›®å½•æ‰§è¡Œå‘½ä»¤
- æ£€æŸ¥ PYTHONPATH è®¾ç½®
- ä½¿ç”¨ç»å¯¹å¯¼å…¥è·¯å¾„

### 4. æƒé™é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `FATAL: password authentication failed`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡ç½® PostgreSQL ç”¨æˆ·å¯†ç 
ALTER USER postgres PASSWORD 'postgres';

# æˆ–åˆ›å»ºæ–°ç”¨æˆ·
CREATE USER claude_user WITH PASSWORD 'claude_pass';
GRANT ALL PRIVILEGES ON DATABASE claude_fastapi TO claude_user;
```

## ç”Ÿäº§ç¯å¢ƒè¿ç§»

### 1. å¤‡ä»½æ•°æ®åº“

```bash
pg_dump -h localhost -U postgres -d claude_fastapi > backup.sql
```

### 2. æ‰§è¡Œè¿ç§»

```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
# 2. å¤‡ä»½æ•°æ®åº“
# 3. æ‰§è¡Œè¿ç§»
alembic upgrade head
# 4. å¯åŠ¨åº”ç”¨æœåŠ¡
```

### 3. å›æ»šè®¡åˆ’

```bash
# å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# å›é€€åˆ°ç‰¹å®šç‰ˆæœ¬
alembic downgrade <revision_id>
```

## æœ€ä½³å®è·µ

### 1. è¿ç§»æ–‡ä»¶å‘½å

- ä½¿ç”¨æè¿°æ€§åç§°ï¼š`add_user_table`, `add_email_index`
- åŒ…å«æ—¥æœŸä¿¡æ¯ï¼š`2023_09_04_add_user_table`
- ç‰ˆæœ¬å·é€’å¢ï¼š`001_initial`, `002_add_roles`

### 2. è¿ç§»å†…å®¹

- æ¯æ¬¡è¿ç§»åªåšä¸€ä»¶äº‹
- æä¾›å®Œæ•´çš„ `upgrade()` å’Œ `downgrade()` å‡½æ•°
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œè¯´æ˜

### 3. æµ‹è¯•æµç¨‹

```bash
# 1. æµ‹è¯•å‡çº§
alembic upgrade head

# 2. éªŒè¯æ•°æ®å®Œæ•´æ€§
python -c "from db.base import engine; print(engine.execute('SELECT COUNT(*) FROM users'))"

# 3. æµ‹è¯•å›é€€
alembic downgrade -1

# 4. é‡æ–°å‡çº§
alembic upgrade head
```

### 4. å›¢é˜Ÿåä½œ

- åˆå¹¶ä»£ç å‰å…ˆæ‹‰å–æœ€æ–°è¿ç§»
- è§£å†³è¿ç§»å†²çªåå†æ¨é€
- åœ¨ä¸åŒç¯å¢ƒä¿æŒè¿ç§»åŒæ­¥

## ç›‘æ§å’Œæ—¥å¿—

### 1. è¿ç§»æ—¥å¿—

Alembic ä¼šè®°å½•è¿ç§»æ‰§è¡Œæ—¥å¿—åˆ° `alembic_version` è¡¨ï¼š

```sql
SELECT * FROM alembic_version;
```

### 2. åº”ç”¨æ—¥å¿—

åº”ç”¨å¯åŠ¨æ—¶ä¼šè¾“å‡ºæ•°æ®åº“è¿æ¥çŠ¶æ€ï¼š
```
ğŸš€ Claude FastAPI started successfully!
ğŸ“Š API Documentation: http://localhost:8000/docs
```

## API å¥åº·æ£€æŸ¥

è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹éªŒè¯æ•°æ®åº“è¿æ¥ï¼š
```bash
curl http://localhost:8000/health
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "healthy",
  "redis": "healthy",
  "timestamp": "2023-09-04T22:30:00.000000Z",
  "version": "1.0.0"
}
```

## ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·è®¤è¯APIæ–‡æ¡£](./ç”¨æˆ·è®¤è¯APIæ–‡æ¡£.md)
- [åŠŸèƒ½æ–‡æ¡£](./åŠŸèƒ½æ–‡æ¡£.md)
- [SQLAlchemy å®˜æ–¹æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [Alembic å®˜æ–¹æ–‡æ¡£](https://alembic.sqlalchemy.org/)

---

*æœ¬æ–‡æ¡£éšç€é¡¹ç›®å‘å±•æŒç»­æ›´æ–°*